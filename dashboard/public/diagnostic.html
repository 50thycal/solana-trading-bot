<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bot Diagnostics</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace; background: #0d1117; color: #c9d1d9; padding: 16px; }
    a { color: #58a6ff; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .header h1 { font-size: 20px; color: #f0f6fc; }
    .nav-links { display: flex; gap: 16px; }

    .section { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .section h2 { font-size: 15px; color: #f0f6fc; margin-bottom: 12px; border-bottom: 1px solid #30363d; padding-bottom: 8px; }

    /* Copy button */
    .copy-btn { background: #238636; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
    .copy-btn:hover { background: #2ea043; }
    .copy-btn.copied { background: #1f6feb; }

    /* Summary block */
    .compact-report { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 12px; font-family: monospace; font-size: 13px; white-space: pre-wrap; line-height: 1.6; max-height: 400px; overflow-y: auto; }

    /* Trade audit table */
    .audit-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .audit-table th { text-align: left; padding: 8px; color: #8b949e; border-bottom: 1px solid #30363d; font-weight: 500; }
    .audit-table td { padding: 8px; border-bottom: 1px solid #21262d; }
    .audit-table tr.mismatch { background: #3d1f1f; }
    .audit-table .ok { color: #3fb950; }
    .audit-table .alert { color: #f85149; font-weight: 600; }

    /* Summary cards */
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .summary-card { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 12px; text-align: center; }
    .summary-card .label { font-size: 11px; color: #8b949e; text-transform: uppercase; margin-bottom: 4px; }
    .summary-card .value { font-size: 20px; font-weight: 700; color: #f0f6fc; }
    .summary-card .value.green { color: #3fb950; }
    .summary-card .value.red { color: #f85149; }
    .summary-card .value.yellow { color: #d29922; }

    /* Pipeline funnel compact */
    .funnel { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; margin-bottom: 12px; }
    .funnel-step { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 8px 12px; text-align: center; min-width: 80px; }
    .funnel-step .num { font-size: 18px; font-weight: 700; color: #f0f6fc; }
    .funnel-step .lbl { font-size: 10px; color: #8b949e; text-transform: uppercase; }
    .funnel-arrow { color: #484f58; font-size: 18px; }

    .loading { color: #8b949e; font-style: italic; }
    .refresh-info { font-size: 11px; color: #484f58; margin-top: 8px; }
  </style>
</head>
<body>
  <nav id="nav-bar" class="nav-bar" style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #30363d;margin-bottom:16px"></nav>
  <script src="/nav.js"></script>
  <div class="header">
    <h1>Bot Diagnostics</h1>
  </div>

  <!-- Copy for Claude -->
  <div class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <h2 style="margin-bottom: 0; border: none; padding: 0;">Compact Report</h2>
      <button class="copy-btn" id="copy-btn" onclick="copyReport()">Copy for Claude</button>
    </div>
    <div class="compact-report" id="compact-report">Loading...</div>
    <div class="refresh-info">Auto-refreshes every 10 seconds</div>
  </div>

  <!-- Audit Summary -->
  <div class="section">
    <h2>Trade Audit Summary</h2>
    <div class="summary-cards" id="audit-summary">
      <div class="summary-card"><div class="label">Total Audited</div><div class="value" id="total-audited">0</div></div>
      <div class="summary-card"><div class="label">Buys</div><div class="value" id="total-buys">0</div></div>
      <div class="summary-card"><div class="label">Sells</div><div class="value" id="total-sells">0</div></div>
      <div class="summary-card"><div class="label">Mismatches</div><div class="value" id="total-mismatches">0</div></div>
      <div class="summary-card"><div class="label">Avg SOL Discrepancy</div><div class="value" id="avg-discrepancy">0%</div></div>
      <div class="summary-card"><div class="label">Avg Token Slippage</div><div class="value" id="avg-slippage">0%</div></div>
    </div>
  </div>

  <!-- Pipeline Funnel -->
  <div class="section">
    <h2>Pipeline Funnel</h2>
    <div class="funnel" id="pipeline-funnel">
      <div class="funnel-step"><div class="num" id="f-detected">-</div><div class="lbl">Detected</div></div>
      <div class="funnel-arrow">&rarr;</div>
      <div class="funnel-step"><div class="num" id="f-cheap">-</div><div class="lbl">Cheap Gates</div></div>
      <div class="funnel-arrow">&rarr;</div>
      <div class="funnel-step"><div class="num" id="f-deep">-</div><div class="lbl">Deep Filters</div></div>
      <div class="funnel-arrow">&rarr;</div>
      <div class="funnel-step"><div class="num" id="f-momentum">-</div><div class="lbl">Momentum</div></div>
      <div class="funnel-arrow">&rarr;</div>
      <div class="funnel-step"><div class="num" id="f-bought">-</div><div class="lbl">Bought</div></div>
    </div>
  </div>

  <!-- Recent Trade Audits -->
  <div class="section">
    <h2>Recent Trade Audits</h2>
    <div style="overflow-x: auto;">
      <table class="audit-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Type</th>
            <th>Token</th>
            <th>Intended SOL</th>
            <th>Actual SOL</th>
            <th>Tokens</th>
            <th>Slippage</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="audit-table-body">
          <tr><td colspan="8" class="loading">No trade audits yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Log Summaries -->
  <div class="section">
    <h2>5-Minute Log Summaries</h2>
    <div class="compact-report" id="log-summaries">Loading...</div>
  </div>

  <script>
    const REFRESH_INTERVAL = 10000;

    async function fetchJSON(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) return null;
        return await res.json();
      } catch { return null; }
    }

    async function fetchText(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) return null;
        return await res.text();
      } catch { return null; }
    }

    async function refresh() {
      // Compact report
      const compact = await fetchText('/api/diagnostic/compact');
      if (compact) {
        document.getElementById('compact-report').textContent = compact;
      }

      // Trade audit
      const audit = await fetchJSON('/api/trade-audit');
      if (audit && audit.summary) {
        const s = audit.summary;
        document.getElementById('total-audited').textContent = s.totalAudited;
        document.getElementById('total-buys').textContent = s.totalBuys;
        document.getElementById('total-sells').textContent = s.totalSells;

        const mismEl = document.getElementById('total-mismatches');
        mismEl.textContent = s.mismatches;
        mismEl.className = 'value' + (s.mismatches > 0 ? ' red' : ' green');

        document.getElementById('avg-discrepancy').textContent = s.avgSolDiscrepancyPercent + '%';
        document.getElementById('avg-slippage').textContent = s.avgTokenSlippagePercent + '%';

        // Audit table
        const tbody = document.getElementById('audit-table-body');
        if (audit.recentAudits && audit.recentAudits.length > 0) {
          tbody.innerHTML = audit.recentAudits.slice().reverse().slice(0, 20).map(function(r) {
            const time = new Date(r.timestamp).toLocaleTimeString();
            const cls = r.hasMismatch ? ' class="mismatch"' : '';
            const statusCls = r.hasMismatch ? 'alert' : 'ok';
            const statusText = r.hasMismatch ? 'MISMATCH' : 'OK';
            const actualSol = r.type === 'buy'
              ? (r.actualSolSpent !== null ? r.actualSolSpent.toFixed(6) : '?')
              : (r.actualSolReceived !== null ? r.actualSolReceived.toFixed(6) : '?');
            const tokens = r.actualTokensReceived !== null ? r.actualTokensReceived.toLocaleString() : '-';
            const slippage = r.tokenSlippagePercent !== null ? r.tokenSlippagePercent.toFixed(1) + '%' : '-';
            return '<tr' + cls + '>' +
              '<td>' + time + '</td>' +
              '<td>' + r.type.toUpperCase() + '</td>' +
              '<td>' + (r.tokenSymbol || r.tokenMint.substring(0, 8) + '...') + '</td>' +
              '<td>' + r.intendedAmountSol + '</td>' +
              '<td>' + actualSol + '</td>' +
              '<td>' + tokens + '</td>' +
              '<td>' + slippage + '</td>' +
              '<td class="' + statusCls + '">' + statusText + '</td>' +
              '</tr>';
          }).join('');
        }
      }

      // Pipeline stats
      const stats = await fetchJSON('/api/pipeline-stats');
      if (stats) {
        document.getElementById('f-detected').textContent = stats.tokensDetected || 0;
        document.getElementById('f-bought').textContent = stats.tokensBought || 0;

        // Calculate intermediate funnel steps from gate stats
        if (stats.gateStats) {
          const cheapTotal = stats.gateStats.cheapGates.reduce(function(s, g) { return s + g.passed; }, 0);
          const cheapPassed = stats.gateStats.cheapGates.length > 0 ? stats.gateStats.cheapGates[stats.gateStats.cheapGates.length - 1].passed : 0;
          document.getElementById('f-cheap').textContent = cheapPassed;

          const deepPassed = stats.gateStats.deepFilters.length > 0 ? stats.gateStats.deepFilters[stats.gateStats.deepFilters.length - 1].passed : 0;
          document.getElementById('f-deep').textContent = deepPassed;

          const momPassed = stats.gateStats.momentumGate.length > 0 ? stats.gateStats.momentumGate[0].passed : 0;
          document.getElementById('f-momentum').textContent = momPassed;
        }
      }

      // Log summaries
      const summaries = await fetchJSON('/api/log-summaries');
      if (summaries && summaries.compact) {
        document.getElementById('log-summaries').textContent = summaries.compact;
      } else {
        document.getElementById('log-summaries').textContent = 'No summary data yet. Summaries appear after the first 5-minute period.';
      }
    }

    function copyReport() {
      const text = document.getElementById('compact-report').textContent;
      navigator.clipboard.writeText(text).then(function() {
        const btn = document.getElementById('copy-btn');
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(function() {
          btn.textContent = 'Copy for Claude';
          btn.classList.remove('copied');
        }, 2000);
      });
    }

    // Initial load + auto-refresh
    refresh();
    setInterval(refresh, REFRESH_INTERVAL);
  </script>
</body>
</html>
